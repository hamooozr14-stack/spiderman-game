<!DOCTYPE html>
<html>
<head>
  <title>Spider-Man Ultimate Game</title>
  <style>
    body { margin:0; overflow:hidden; font-family:Arial; background:#87CEEB; }
    canvas { display:block; margin:auto; background:#87CEEB; }
    #overlay, #difficultyOverlay, #gameOverOverlay {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.85); color:white; display:flex;
      flex-direction:column; justify-content:center; align-items:center; z-index:10;
    }
    button { padding:10px 20px; margin:10px; font-size:16px; cursor:pointer; }
    #backBtn, #restartBtn {
      position:absolute; top:10px; right:10px; z-index:5; padding:8px 16px; font-size:14px; cursor:pointer; display:none;
    }
    #restartBtn { right:120px; }
  </style>
</head>
<body>

<div id="overlay">
  <h1>Spider-Man Game</h1>
  <p>Select Level:</p>
  <div>
    <button onclick="selectLevel(1)">Level 1</button>
    <button onclick="selectLevel(2)">Level 2</button>
    <button onclick="selectLevel(3)">Level 3</button>
    <button onclick="selectLevel(4)">Level 4</button>
    <button onclick="selectLevel(5)">Level 5</button>
  </div>
</div>

<div id="difficultyOverlay" style="display:none;">
  <h2>Level <span id="levelNumber">1</span> - Select Difficulty</h2>
  <div>
    <button onclick="startGame('easy')">Easy</button>
    <button onclick="startGame('medium')">Medium</button>
    <button onclick="startGame('hard')">Hard</button>
    <button onclick="startGame('impossible')">Impossible</button>
  </div>
</div>

<div id="gameOverOverlay" style="display:none;">
  <h1>GAME OVER</h1>
  <p id="finalScore"></p>
  <p id="finalHighScore"></p>
  <p id="finalTime"></p>
  <button onclick="restartGame()">Restart Level</button>
  <button onclick="backToMenu()">Back to Menu</button>
</div>

<button id="backBtn" onclick="backToMenu()">Back</button>
<button id="restartBtn" onclick="restartGame()">Restart</button>

<canvas id="game" width="1000" height="500"></canvas>

<script>
// Canvas
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// UI Elements
let overlay = document.getElementById("overlay");
let difficultyOverlay = document.getElementById("difficultyOverlay");
let levelNumberEl = document.getElementById("levelNumber");
let backBtn = document.getElementById("backBtn");
let restartBtn = document.getElementById("restartBtn");
let gameOverOverlay = document.getElementById("gameOverOverlay");
let finalScoreEl = document.getElementById("finalScore");
let finalHighEl = document.getElementById("finalHighScore");
let finalTimeEl = document.getElementById("finalTime");

// Input
let keys = {};
let mouse = {x:0, y:0, down:false};
window.addEventListener("keydown", e => keys[e.code]=true);
window.addEventListener("keyup", e => keys[e.code]=false);
canvas.addEventListener("mousedown", e => { mouse.down=true; mouse.x=e.offsetX; mouse.y=e.offsetY; });
canvas.addEventListener("mouseup", e => { mouse.down=false; });
canvas.addEventListener("mousemove", e => { mouse.x=e.offsetX; mouse.y=e.offsetY; });

// Game variables
let spiderman, cameraX, gravity, projectiles, enemies, powerUps, obstacles, buildings;
let gameStarted=false, gameOver=false, currentLevel=1, currentDifficulty='easy', startTime=0;
let highScores = {}; // keys: "level_difficulty"

// Sound Effects
let jumpSound = new Audio("https://www.soundjay.com/button/beep-07.mp3");
let swingSound = new Audio("https://www.soundjay.com/button/button-16.mp3");
let hitSound = new Audio("https://www.soundjay.com/button/button-3.mp3");
let gameOverSound = new Audio("https://www.soundjay.com/button/beep-10.mp3");

// Helper: generate high score key
function hsKey(level,diff){ return `level${level}_${diff}`; }

// Load saved high scores
for(let l=1;l<=5;l++){
  ['easy','medium','hard','impossible'].forEach(diff=>{
    let stored = localStorage.getItem(hsKey(l,diff));
    highScores[hsKey(l,diff)] = stored?parseInt(stored):0;
  });
});

// Level selection
function selectLevel(level){
  currentLevel = level;
  overlay.style.display="none";
  difficultyOverlay.style.display="flex";
  levelNumberEl.textContent = level;
}

// Back to menu
function backToMenu(){
  overlay.style.display="flex";
  difficultyOverlay.style.display="none";
  backBtn.style.display="none";
  restartBtn.style.display="none";
  gameOverOverlay.style.display="none";
  gameStarted=false;
}

// Start game after difficulty selected
function startGame(diff){
  currentDifficulty = diff;
  difficultyOverlay.style.display="none";
  backBtn.style.display="block";
  restartBtn.style.display="block";
  gameOverOverlay.style.display="none";
  initGame(currentLevel,currentDifficulty);
  gameStarted=true;
  startTime = Date.now();
  loop();
}

// Restart current level
function restartGame(){
  initGame(currentLevel,currentDifficulty);
  spiderman.health=100;
  spiderman.score=0;
  gameOver=false;
  gameStarted=true;
  startTime = Date.now();
}

// Initialize Game
function initGame(level,difficulty){
  spiderman={x:100,y:350,w:40,h:60,dx:0,dy:0,onGround:false,swinging:false,web:null,score:0,health:100};
  cameraX=0; gravity=0.6; projectiles=[]; enemies=[]; powerUps=[]; obstacles=[]; buildings=[];
  
  // Level-specific parameters
  let enemyCount = 3;
  let obstacleCount = 0;
  let powerUpCount = 0;
  let mapLength = 2000;
  
  if(level===1){ enemyCount=3; mapLength=1500; }
  if(level===2){ enemyCount=5; powerUpCount=3; mapLength=1800; }
  if(level===3){ enemyCount=8; obstacleCount=3; mapLength=2000; }
  if(level===4){ enemyCount=12; obstacleCount=5; powerUpCount=4; mapLength=2500; }
  if(level===5){ enemyCount=20; obstacleCount=6; powerUpCount=5; mapLength=3000; }

  // Difficulty multiplier
  let diffMultiplier=1;
  if(difficulty==='medium') diffMultiplier=1.5;
  if(difficulty==='hard') diffMultiplier=2;
  if(difficulty==='impossible') diffMultiplier=3;
  enemyCount = Math.floor(enemyCount*diffMultiplier);

  // Buildings
  for(let i=0;i<Math.ceil(mapLength/120);i++){
    let w=50+Math.random()*50;
    let h=150+Math.random()*200;
    let x=i*120;
    let y=canvas.height-h-20;
    let color=`rgb(${50+Math.random()*100},${50+Math.random()*100},${50+Math.random()*100})`;
    buildings.push({x,y,w,h,color});
  }

  // Obstacles
  for(let i=0;i<obstacleCount;i++){
    let x=200+i*300;
    let y=250+Math.random()*150;
    obstacles.push({x,y,w:50,h:10,dx:Math.random()<0.5?1:-1});
  }

  // Power-ups
  for(let i=0;i<powerUpCount;i++){
    let x=150+i*400;
    let y=200+Math.random()*150;
    let type=Math.random()<0.5?"health":"speed";
    powerUps.push({x,y,type,collected:false});
  }

  // Enemies
  for(let i=0;i<enemyCount;i++){
    spawnEnemy();
  }
}

// Spawn Enemy (random color and hit points)
function spawnEnemy(){
  let x=500+Math.random()*1000;
  let y=350;
  let dx=Math.random()<0.5?1.5: -1.5;
  let colorChoice = ['green','blue','red'];
  let color = colorChoice[Math.floor(Math.random()*colorChoice.length)];
  let hitsRequired = color==='green'?1:color==='blue'?2:3;
  enemies.push({x,y,w:30,h:40,dx,color,hits:hitsRequired});
}

// Shoot Web
function shootProjectile(){
  let dir = keys["ArrowRight"]?1:keys["ArrowLeft"]?-1:1;
  projectiles.push({x:spiderman.x + (dir>0?40:0), y:spiderman.y +30, dx:8*dir});
  swingSound.play();
}

// Update
function update(){
  if(!gameStarted || gameOver) return;
  cameraX = spiderman.x - 200;
  spiderman.dx = 0;

  // Movement
  if(keys["ArrowLeft"]) spiderman.dx=-5;
  if(keys["ArrowRight"]) spiderman.dx=5;

  // Jump
  if(keys["ArrowUp"] && spiderman.onGround){ spiderman.dy=-12; spiderman.onGround=false; jumpSound.play(); }

  // Shoot
  if(keys["Space"]){ shootProjectile(); keys["Space"]=false; }

  // Swing
  if(mouse.down && !spiderman.swinging){
    spiderman.web={x:mouse.x+cameraX,y:mouse.y};
    let dx = spiderman.web.x - (spiderman.x+20);
    let dy = spiderman.web.y - (spiderman.y+30);
    spiderman.swingLength = Math.sqrt(dx*dx + dy*dy);
    spiderman.swingAngle = Math.atan2(dy,dx);
    spiderman.swingSpeed=0;
    spiderman.swinging=true;
  }

  if(spiderman.swinging && spiderman.web){
    let g=gravity;
    spiderman.swingSpeed += (g/spiderman.swingLength)*Math.sin(spiderman.swingAngle);
    spiderman.swingSpeed *=0.995;
    spiderman.swingAngle += spiderman.swingSpeed;
    spiderman.x = spiderman.web.x - Math.cos(spiderman.swingAngle)*spiderman.swingLength - spiderman.w/2;
    spiderman.y = spiderman.web.y - Math.sin(spiderman.swingAngle)*spiderman.swingLength - spiderman.h/2;
    spiderman.x += spiderman.dx;

    if(!mouse.down){
      spiderman.dx += spiderman.swingSpeed*spiderman.swingLength*0.1;
      spiderman.dy = spiderman.swingSpeed*spiderman.swingLength*0.2;
      spiderman.swinging=false;
      spiderman.web=null;
    }
  } else {
    spiderman.dy+=gravity;
    spiderman.x+=spiderman.dx;
    spiderman.y+=spiderman.dy;
  }

  spiderman.onGround=false;

  // Buildings collision
  buildings.forEach(b=>{
    if(spiderman.x< b.x+b.w && spiderman.x+spiderman.w> b.x &&
       spiderman.y+spiderman.h> b.y && spiderman.y+spiderman.h< b.y+20){
         spiderman.y=b.y-spiderman.h;
         spiderman.dy=0;
         spiderman.onGround=true;
         spiderman.swinging=false;
         spiderman.web=null;
    }
  });

  // Obstacles
  obstacles.forEach(obs=>{
    obs.x+=obs.dx;
    if(obs.x<0 || obs.x>3000) obs.dx*=-1;
    if(spiderman.x< obs.x+obs.w && spiderman.x+spiderman.w> obs.x &&
       spiderman.y+spiderman.h>obs.y && spiderman.y+spiderman.h<obs.y+10){
         spiderman.y=obs.y-spiderman.h;
         spiderman.dy=0;
         spiderman.onGround=true;
    }
  });

  // Ground
  if(spiderman.y+spiderman.h>canvas.height-20){
    spiderman.y=canvas.height-20-spiderman.h;
    spiderman.dy=0;
    spiderman.onGround=true;
  }

  // Projectiles
  projectiles.forEach(p=>p.x+=p.dx);
  projectiles=projectiles.filter(p=>p.x>cameraX && p.x<cameraX+canvas.width);

  // Enemies collisions
  enemies.forEach((e,ei)=>{
    e.x+=e.dx;
    if(e.x<0 || e.x>3000) e.dx*=-1;

    projectiles.forEach((p,pi)=>{
      if(p.x<e.x+e.w && p.x+10>e.x && p.y<e.y+e.h && p.y>e.y){
        e.hits--;
        projectiles.splice(pi,1);
        if(e.hits<=0){
          enemies.splice(ei,1);
          spiderman.score+=10;
          hitSound.play();
        }
      }
    });

    if(spiderman.x<e.x+e.w && spiderman.x+spiderman.w>e.x &&
       spiderman.y<e.y+e.h && spiderman.y+spiderman.h>e.y){
      spiderman.health-=0.5;
    }
  });

  // Power-ups
  powerUps.forEach(p=>{
    if(!p.collected && spiderman.x<p.x+20 && spiderman.x+spiderman.w>p.x &&
       spiderman.y< p.y+20 && spiderman.y+spiderman.h>p.y){
      p.collected=true;
      if(p.type==="health") spiderman.health+=20;
      if(p.type==="speed") spiderman.dx*=1.5;
    }
  });

  // High score
  let key = hsKey(currentLevel,currentDifficulty);
  if(spiderman.score>highScores[key]){
    highScores[key] = Math.floor(spiderman.score);
    localStorage.setItem(key, highScores[key]);
  }

  // Level complete
  if(enemies.length===0 && !gameOver){
    alert(`Level ${currentLevel} Complete!`);
    if(currentLevel<5){ selectLevel(currentLevel+1); }
    else { gameOver=true; showGameOver(); }
  }

  if(spiderman.health<=0){ gameOver=true; gameStarted=false; gameOverSound.play(); showGameOver(); }

  draw();
}

// Show Game Over
function showGameOver(){
  finalScoreEl.textContent = "Score: "+Math.floor(spiderman.score);
  finalHighEl.textContent = "High Score (Level "+currentLevel+"-"+currentDifficulty+"): "+highScores[hsKey(currentLevel,currentDifficulty)];
  let seconds = Math.floor((Date.now()-startTime)/1000);
  finalTimeEl.textContent = "Time Survived: "+seconds+" seconds";
  gameOverOverlay.style.display="flex";
}

// Draw everything
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Background
  ctx.fillStyle="#87CEEB";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Ground
  ctx.fillStyle="#654321";
  ctx.fillRect(0,canvas.height-20,canvas.width,20);

  // Buildings
  buildings.forEach(b=>{
    ctx.fillStyle=b.color;
    ctx.fillRect(b.x - cameraX, b.y, b.w, b.h);
    for(let wx=5; wx<b.w; wx+=15){
      for(let wy=5; wy<b.h; wy+=20){
        ctx.fillStyle="yellow";
        ctx.fillRect(b.x - cameraX + wx, b.y+wy, 5,10);
      }
    }
  });

  // Obstacles
  ctx.fillStyle="brown";
  obstacles.forEach(o=>ctx.fillRect(o.x - cameraX,o.y,o.w,o.h));

  // Power-ups
  powerUps.forEach(p=>{
    if(!p.collected){
      ctx.fillStyle=p.type==="health"?"pink":"cyan";
      ctx.fillRect(p.x - cameraX,p.y,20,20);
    }
  });

  // Swing web
  if(spiderman.swinging && spiderman.web){
    ctx.strokeStyle="white";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(spiderman.x+20 - cameraX, spiderman.y+30);
    ctx.lineTo(spiderman.web.x - cameraX, spiderman.web.y);
    ctx.stroke();
  }

  // Spider-Man
  ctx.fillStyle="red";
  ctx.fillRect(spiderman.x - cameraX, spiderman.y+20, spiderman.w, 40);
  ctx.beginPath();
  ctx.arc(spiderman.x+20 - cameraX, spiderman.y+10, 10,0,Math.PI*2);
  ctx.fill();

  // Projectiles
  ctx.fillStyle="yellow";
  projectiles.forEach(p=>ctx.fillRect(p.x - cameraX,p.y,10,2));

  // Enemies
  enemies.forEach(e=>{
    ctx.fillStyle=e.color;
    ctx.fillRect(e.x - cameraX,e.y,e.w,e.h);
  });

  // UI
  ctx.fillStyle="white";
  ctx.font="16px Arial";
  ctx.fillText("Health: "+Math.floor(spiderman.health),10,20);
  ctx.fillText("Score: "+Math.floor(spiderman.score),10,40);
  ctx.fillText("High Score (L"+currentLevel+"-"+currentDifficulty+"): "+highScores[hsKey(currentLevel,currentDifficulty)],
