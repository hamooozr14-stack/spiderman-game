<!DOCTYPE html>
<html>
<head>
  <title>Spider-Man Game</title>
  <style>
    body { margin:0; overflow:hidden; font-family:Arial; background:#87CEEB; }
    canvas { display:block; margin:auto; background:#87CEEB; z-index:1; }
    #overlay, #difficultyOverlay, #gameOverOverlay, #levelEndOverlay {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.85); color:white; display:flex;
      flex-direction:column; justify-content:center; align-items:center; z-index:1000;
    }
    button { padding:10px 20px; margin:10px; font-size:16px; cursor:pointer; }
    #backBtn, #restartBtn { position:absolute; top:10px; right:10px; z-index:5; padding:8px 16px; font-size:14px; cursor:pointer; display:none; }
    #restartBtn { right:120px; }
    #mobileControls {
      position:absolute; bottom:10px; left:50%; transform:translateX(-50%); display:flex; gap:10px; z-index:5;
    }
    .mobileBtn { padding:15px 20px; font-size:18px; opacity:0.6; border-radius:5px; background:black; color:white; user-select:none; }
  </style>
</head>
<body>

<div id="overlay">
  <h1>Spider-Man Game</h1>
  <p>Select Level:</p>
  <div>
    <button onclick="selectLevel(1)">Level 1</button>
    <button onclick="selectLevel(2)">Level 2</button>
    <button onclick="selectLevel(3)">Level 3</button>
    <button onclick="selectLevel(4)">Level 4</button>
    <button onclick="selectLevel(5)">Level 5</button>
  </div>
</div>

<div id="difficultyOverlay" style="display:none;">
  <h2>Level <span id="levelNumber">1</span> - Select Difficulty</h2>
  <div>
    <button onclick="startGame('easy')">Easy</button>
    <button onclick="startGame('medium')">Medium</button>
    <button onclick="startGame('hard')">Hard</button>
    <button onclick="startGame('impossible')">Impossible</button>
  </div>
</div>

<div id="levelEndOverlay" style="display:none;">
  <h1>You Won the Level!</h1>
  <button onclick="nextLevel()">Next Level</button>
</div>

<div id="gameOverOverlay" style="display:none;">
  <h1>GAME OVER</h1>
  <p id="finalScore"></p>
  <p id="finalHighScore"></p>
  <p id="finalTime"></p>
  <button onclick="restartGame()">Restart Level</button>
  <button onclick="backToMenu()">Back to Menu</button>
</div>

<button id="backBtn" onclick="backToMenu()">Back</button>
<button id="restartBtn" onclick="restartGame()">Restart</button>

<div id="mobileControls">
  <div class="mobileBtn" id="leftBtn">‚¨ÖÔ∏è</div>
  <div class="mobileBtn" id="rightBtn">‚û°Ô∏è</div>
  <div class="mobileBtn" id="jumpBtn">‚¨ÜÔ∏è</div>
  <div class="mobileBtn" id="shootBtn">üï∏Ô∏è</div>
</div>

<canvas id="game" width="1000" height="500"></canvas>

<script>
// --- Canvas and UI ---
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
let overlay = document.getElementById("overlay");
let difficultyOverlay = document.getElementById("difficultyOverlay");
let levelNumberEl = document.getElementById("levelNumber");
let backBtn = document.getElementById("backBtn");
let restartBtn = document.getElementById("restartBtn");
let gameOverOverlay = document.getElementById("gameOverOverlay");
let levelEndOverlay = document.getElementById("levelEndOverlay");
let finalScoreEl = document.getElementById("finalScore");
let finalHighEl = document.getElementById("finalHighScore");
let finalTimeEl = document.getElementById("finalTime");

// --- Input ---
let keys = {};
window.addEventListener("keydown", e=>keys[e.code]=true);
window.addEventListener("keyup", e=>keys[e.code]=false);

// Mobile buttons
document.getElementById("leftBtn").addEventListener("touchstart", ()=>keys["ArrowLeft"]=true);
document.getElementById("leftBtn").addEventListener("touchend", ()=>keys["ArrowLeft"]=false);
document.getElementById("rightBtn").addEventListener("touchstart", ()=>keys["ArrowRight"]=true);
document.getElementById("rightBtn").addEventListener("touchend", ()=>keys["ArrowRight"]=false);
document.getElementById("jumpBtn").addEventListener("touchstart", ()=>keys["ArrowUp"]=true);
document.getElementById("jumpBtn").addEventListener("touchend", ()=>keys["ArrowUp"]=false);
document.getElementById("shootBtn").addEventListener("touchstart", ()=>keys["Space"]=true);
document.getElementById("shootBtn").addEventListener("touchend", ()=>keys["Space"]=false);

// --- Game Variables ---
let spiderman, cameraX, gravity, projectiles, enemies, enemyBullets, powerUps, obstacles, buildings;
let gameStarted=false, gameOver=false, currentLevel=1, currentDifficulty='easy', startTime=0;
let highScores = {};

// Sounds
let jumpSound = new Audio("https://www.soundjay.com/button/beep-07.mp3");
let swingSound = new Audio("https://www.soundjay.com/button/button-16.mp3");
let hitSound = new Audio("https://www.soundjay.com/button/button-3.mp3");
let gameOverSound = new Audio("https://www.soundjay.com/button/beep-10.mp3");

// High Score Helper
function hsKey(level,diff){ return `level${level}_${diff}`; }
for(let l=1;l<=5;l++){
  ['easy','medium','hard','impossible'].forEach(diff=>{
    let stored = localStorage.getItem(hsKey(l,diff));
    highScores[hsKey(l,diff)] = stored?parseInt(stored):0;
  });
}

// --- LEVEL FUNCTIONS ---
function selectLevel(level){
  currentLevel = level;
  overlay.style.display="none";
  difficultyOverlay.style.display="flex";
  levelNumberEl.textContent = level;
}
function backToMenu(){
  overlay.style.display="flex"; difficultyOverlay.style.display="none";
  backBtn.style.display="none"; restartBtn.style.display="none";
  gameOverOverlay.style.display="none"; levelEndOverlay.style.display="none";
  gameStarted=false;
}
function startGame(diff){
  currentDifficulty = diff;
  difficultyOverlay.style.display="none";
  backBtn.style.display="block"; restartBtn.style.display="block";
  gameOverOverlay.style.display="none"; levelEndOverlay.style.display="none";
  initGame(currentLevel,currentDifficulty);
  gameStarted=true; startTime=Date.now(); loop();
}
function restartGame(){ initGame(currentLevel,currentDifficulty); spiderman.health=100; spiderman.score=0; gameOver=false; gameStarted=true; startTime=Date.now(); }
function nextLevel(){ levelEndOverlay.style.display="none"; if(currentLevel<5){ selectLevel(currentLevel+1); } else { alert("You finished all levels!"); backToMenu(); } }

// --- INIT GAME ---
function initGame(level,diff){
  spiderman={x:100,y:350,w:40,h:60,dx:0,dy:0,onGround:false,swinging:false,web:null,score:0,health:100};
  cameraX=0; gravity=0.7; projectiles=[]; enemies=[]; enemyBullets=[]; powerUps=[]; obstacles=[]; buildings=[];
  
  let enemyCount=[6,10,12,15,18][level-1];
  let obstacleCount=[0,1,2,3,4][level-1];
  let powerUpCount=[0,1,2,2,3][level-1];
  let mapLength=[1500,1800,2000,2500,3000][level-1];

  let multiplier = diff==='medium'?1.5: diff==='hard'?2: diff==='impossible'?3:1;
  enemyCount = Math.floor(enemyCount*multiplier);

  // Buildings
  for(let i=0;i<Math.ceil(mapLength/120);i++){
    let w=50+Math.random()*50, h=150+Math.random()*200, x=i*120, y=canvas.height-h-20;
    let color=`rgb(${50+Math.random()*100},${50+Math.random()*100},${50+Math.random()*100})`;
    buildings.push({x,y,w,h,color});
  }
  // Obstacles
  for(let i=0;i<obstacleCount;i++){ let x=200+i*300,y=250+Math.random()*150; obstacles.push({x,y,w:50,h:10,dx:Math.random()<0.5?1.5:-1.5}); }
  // Power-ups
  for(let i=0;i<powerUpCount;i++){ let x=150+i*400,y=200+Math.random()*150; let type=Math.random()<0.5?"health":"speed"; powerUps.push({x,y,type,collected:false}); }
  // Enemies
  for(let i=0;i<enemyCount;i++) spawnEnemy();
}

// --- SPAWN ENEMY ---
function spawnEnemy(){
  let x=500+Math.random()*1000, y=350, dx=(Math.random()*2+1)*(Math.random()<0.5?-1:1);
  let colors=['green','blue','red']; let color=colors[Math.floor(Math.random()*colors.length)];
  let hits = color==='green'?1:color==='blue'?2:3;
  let hasGun = Math.random()<0.3; // 30% chance enemy has a gun
  enemies.push({x,y,w:30,h:40,dx,color,hits,maxHits:hits,gun:hasGun,shootTimer:Math.random()*100});
}

// --- SHOOT WEB ---
function shootProjectile(){ 
  let dir = keys["ArrowRight"]?1:keys["ArrowLeft"]?-1:1;
  projectiles.push({x:spiderman.x + (dir>0?40:0), y:spiderman.y +30, dx:8*dir});
  swingSound.play();
}

// --- UPDATE GAME ---
function update(){
  if(!gameStarted || gameOver) return;
  cameraX = spiderman.x - 200;
  spiderman.dx = 0;
  if(keys["ArrowLeft"]) spiderman.dx=-5;
  if(keys["ArrowRight"]) spiderman.dx=5;
  if(keys["ArrowUp"] && spiderman.onGround){ spiderman.dy=-12; spiderman.onGround=false; jumpSound.play(); }
  if(keys["Space"]){ shootProjectile(); keys["Space"]=false; }

  // --- Swinging ---
  if(spiderman.swinging && spiderman.web){
    let dx = spiderman.web.x - (spiderman.x + spiderman.w/2);
    let dy = spiderman.web.y - (spiderman.y + spiderman.h/2);
    let length = Math.sqrt(dx*dx + dy*dy);
    let angle = Math.atan2(dy, dx);
    let force = 0.1;
    spiderman.x += Math.cos(angle)*force;
    spiderman.y += Math.sin(angle)*force;
  } else {
    spiderman.dy += gravity;
    spiderman.x += spiderman.dx;
    spiderman.y += spiderman.dy;
  }

  spiderman.onGround=false;
  if(spiderman.y+spiderman.h>canvas.height-20){ spiderman.y=canvas.height-20-spiderman.h; spiderman.dy=0; spiderman.onGround=true; }

  // Projectiles
  projectiles.forEach(p=>p.x+=p.dx);
  projectiles=projectiles.filter(p=>p.x>cameraX && p.x<cameraX+canvas.width);

  // Enemy bullets
  enemyBullets.forEach(b=>{ b.x+=b.dx; b.y+=b.dy; if(b.x>cameraX && b.x<cameraX+canvas.width && b.y<canvas.height){ if(spiderman.x< b.x && spiderman.x+spiderman.w> b.x && spiderman.y< b.y && spiderman.y+spiderman.h> b.y){ spiderman.health-=5; } } });
  enemyBullets = enemyBullets.filter(b=>b.y<canvas.height);

  // Enemies
  enemies.forEach((e,ei)=>{
    e.x+=e.dx;
    // Bounce off buildings
    buildings.forEach(b=>{
      if(e.x< b.x+b.w && e.x+e.w> b.x && e.y+e.h> b.y){ e.dx*=-1; }
    });
    // Shoot bullets if gun
    if(e.gun){ e.shootTimer--; if(e.shootTimer<=0){ let angle = Math.atan2(spiderman.y-e.y,spiderman.x-e.x); enemyBullets.push({x:e.x+15,y:e.y+20,dx:Math.cos(angle)*5,dy:Math.sin(angle)*5}); e.shootTimer=100+Math.random()*50; } }
    // Hit by player web
    projectiles.forEach((p,pi)=>{
      if(p.x<e.x+e.w && p.x+10>e.x && p.y<e.y+e.h && p.y>e.y){
        e.hits--; projectiles.splice(pi,1);
        if(e.hits<=0){ enemies.splice(ei,1); spiderman.score+=10; hitSound.play(); }
      }
    });
    // Collision with player
    if(spiderman.x<e.x+e.w && spiderman.x+spiderman.w>e.x && spiderman.y<e.y+e.h && spiderman.y+spiderman.h>e.y){ spiderman.health-=0.5; }
  });

  // Power-ups
  powerUps.forEach(p=>{ if(!p.collected && spiderman.x<p.x+20 && spiderman.x+spiderman.w>p.x && spiderman.y<p.y+20 && spiderman.y+spiderman.h>p.y){ p.collected=true; if(p.type==="health") spiderman.health+=20; if(p.type==="speed") spiderman.dx*=1.5; } });

  // High score
  let key = hsKey(currentLevel,currentDifficulty);
  if(spiderman.score>highScores[key]){ highScores[key]=Math.floor(spiderman.score); localStorage.setItem(key, highScores[key]); }

  // Level end
  if(enemies.length===0 && !gameOver){ gameStarted=false; levelEndOverlay.style.display="flex"; }

  if(spiderman.health<=0){ gameOver=true; gameStarted=false; gameOverSound.play(); showGameOver(); }

  draw();
}

// --- GAME OVER ---
function showGameOver(){
  finalScoreEl.textContent = "Score: "+Math.floor(spiderman.score);
  finalHighEl.textContent = "High Score (L"+currentLevel+"-"+currentDifficulty+"): "+highScores[hsKey(currentLevel,currentDifficulty)];
  let seconds = Math.floor((Date.now()-startTime)/1000);
  finalTimeEl.textContent = "Time Survived: "+seconds+" seconds";
  gameOverOverlay.style.display="flex";
}

// --- DRAW ---
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#87CEEB"; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#654321"; ctx.fillRect(0,canvas.height-20,canvas.width,20);

  buildings.forEach(b=>{ ctx.fillStyle=b.color; ctx.fillRect(b.x-cameraX,b.y,b.w,b.h);
    for(let wx=5; wx<b.w; wx+=15){ for(let wy=5; wy<b.h; wy+=20){ ctx.fillStyle="yellow"; ctx.fillRect(b.x-cameraX+wx,b.y+wy,5,10); } } 
  });
  obstacles.forEach(o=>{ ctx.fillStyle="brown"; ctx.fillRect(o.x-cameraX,o.y,o.w,o.h); });
  powerUps.forEach(p=>{ if(!p.collected){ ctx.fillStyle=p.type==="health"?"pink":"cyan"; ctx.fillRect(p.x-cameraX,p.y,20,20); } });

  if(spiderman.swinging && spiderman.web){ ctx.strokeStyle="white"; ctx.lineWidth=2; ctx.beginPath();
    ctx.moveTo(spiderman.x+spiderman.w/2-cameraX, spiderman.y+spiderman.h/2); ctx.lineTo(spiderman.web.x-cameraX, spiderman.web.y); ctx.stroke();
  }

  ctx.fillStyle="red"; ctx.fillRect(spiderman.x-cameraX,spiderman.y+20,spiderman.w,40);
  ctx.beginPath(); ctx.arc(spiderman.x+20-cameraX,spiderman.y+10,10,0,Math.PI*2); ctx.fill();

  ctx.fillStyle="white"; projectiles.forEach(p=>ctx.fillRect(p.x-cameraX,p.y,10,2));
  enemyBullets.forEach(b=>{ ctx.fillStyle="black"; ctx.fillRect(b.x-cameraX,b.y,5,5); });

  enemies.forEach(e=>{ ctx.fillStyle=e.color; ctx.fillRect(e.x-cameraX,e.y,e.w,e.h);
    if(e.gun){ ctx.fillStyle="black"; ctx.fillRect(e.x+10-cameraX,e.y-5,10,5); }
  });

  ctx.fillStyle="white"; ctx.font="16px Arial";
  ctx.fillText("Health: "+Math.floor(spiderman.health),10,20);
  ctx.fillText("Score: "+Math.floor(spiderman.score),10,40);
  ctx.fillText("High Score (L"+currentLevel
